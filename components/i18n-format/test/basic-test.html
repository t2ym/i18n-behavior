<!--
@license https://github.com/t2ym/i18n-format/blob/master/LICENSE.md
Copyright (c) 2016, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../i18n-format.html">
    <link rel="import" href="bound-i18n-format.html">
  </head>
  <body>

    <test-fixture id="default">
      <template is="dom-template">
        <i18n-format></i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="static">
      <template is="dom-template">
        <i18n-format lang="en">
          <span>Parameter {1} and {2} are rendered.</span>
          <b>A</b>
          <i>B</i>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="non-default-attributes">
      <template is="dom-template">
        <i18n-format lang="fr" param-attribute="parameter" param-format="%n%">
          <span>Parameter %1% and %2% are rendered.</span>
          <b>A</b>
          <i>B</i>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="bound">
      <template is="dom-template" id="bound-template">
        <i18n-format lang="{{lang}}">
          <span>{{text.0}}</span>
          <b>{{text.1}}</b>
          <i>{{text.2}}</i>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="compound-static">
      <template is="dom-template">
        <i18n-format lang="en">
          <json-data>{
            "0": "You ({3}) gave no gifts.",
            "1": {
              "male": "You ({3}) gave him ({4}) {5}.",
              "female": "You ({3}) gave her ({4}) {5}.",
              "other": "You ({3}) gave them ({4}) {5}."
            },
            "one": {
              "male": "You ({3}) gave him ({4}) and one other person {5}.",
              "female": "You ({3}) gave her ({4}) and one other person {5}.",
              "other": "You ({3}) gave them ({4}) and one other person {5}."
            },
            "other": "You ({3}) gave them ({4}) and {1} other people gifts."
          }</json-data>
          <i18n-number lang="en" offset="1">2</i18n-number>
          <span>female</span>
          <span>Joe</span>
          <span>Alice</span>
          <span>a gift</span>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="bound-and-wrapped">
      <template is="dom-template" id="bound-and-wrapped-template">
        <bound-i18n-format 
          locale="{{lang}}"
          text="{{text}}"
          param-format="{{paramFormat}}"
          compound-text="{{compoundText}}"
          recipients="{{recipients}}"
          sender="{{sender}}"></bound-i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="json-error-static">
      <template is="dom-template">
        <i18n-format>
          <json-data>ERROR</json-data>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="no-template-found-static">
      <template is="dom-template">
        <i18n-format lang="en">
          <json-data>{
            "male": "He ({2}) is {1}.",
            "female": "She ({2}) is {1}."
          }</json-data>
          <span>unknown</span>
          <span>Yoda</span>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="default-number-category-static">
      <template is="dom-template">
        <i18n-format lang="en">
          <json-data>{
            "other": "Default number for {1}."
          }</json-data>
          <i18n-number lang="en" offset="0">1</i18n-number>
        </i18n-format>
      </template>
    </test-fixture>

    <test-fixture id="invalid-template-static">
      <template is="dom-template">
        <i18n-format lang="en">
          <json-data>{
            "other": 1
          }</json-data>
          <i18n-number lang="en" offset="0">1</i18n-number>
        </i18n-format>
      </template>
    </test-fixture>

    <script>
suite('<i18n-format>', function () {

  suite('default values', function () {
    var el;

    setup(function () {
      el = fixture('default');
    });

    test('default lang property', function () {
      assert.equal(el.lang, 'en', 'default lang is en');
    });

    test('DEFAULT_LANG property', function () {
      assert.equal(el.DEFAULT_LANG, 'en', 'DEFAULT_LANG is en');
    });

    test('default paramAttribute property', function () {
      assert.equal(el.paramAttribute, 'param', 'default paramAttribute is param');
    });

    test('default paramFormat property', function () {
      assert.equal(el.paramFormat, '{n}', 'default paramFormat is {n}');
    });

    test('default observeParams property', function () {
      assert.isBoolean(el.observeParams, 'observeParams is a Boolean');
      assert.equal(el.observeParams, true, 'default observeParams is true');
    });

    test('default textContent is empty', function () {
      assert.equal(Polymer.dom(el.root).textContent, '', 'textContent is empty');
    });

  });

  if (!Number.isNaN) {
    // polyfill Number.isNaN for IE11
    Number.isNaN = function (value) {
      return typeof value === 'number' && isNaN(value);
    };
  }
  var lang1 = 'en';
  var lang2 = 'fr';
  var lang3 = 'ja';
  var lang4 = 'xx';
  var paramAttribute1 = 'param';
  var paramAttribute2 = 'parameter';
  var paramFormat1 = '{n}';
  var paramFormat2 = '%n%';

  var suites = [
    { 
      suite: 'static values', 
      fixture: 'static', 
      model: undefined, 
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'Parameter ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' and ' },
        { nodeName: 'CONTENT', select: '[param=\'2\']' },
        { nodeName: '#text', data: ' are rendered.' }
      ],
      parameters: [
        { select: 'b[param=\'1\']', textContent: 'A' },
        { select: 'i[param=\'2\']', textContent: 'B' }
      ]
    },
    { 
      suite: 'non-default static parameters', 
      fixture: 'non-default-attributes', 
      model: undefined, 
      lang: lang2,
      paramAttribute: paramAttribute2,
      paramFormat: paramFormat2,
      childNodes: [
        { nodeName: '#text', data: 'Parameter ' },
        { nodeName: 'CONTENT', select: '[parameter=\'1\']' },
        { nodeName: '#text', data: ' and ' },
        { nodeName: 'CONTENT', select: '[parameter=\'2\']' },
        { nodeName: '#text', data: ' are rendered.' }
      ],
      parameters: [
        { select: 'b[parameter=\'1\']', textContent: 'A' },
        { select: 'i[parameter=\'2\']', textContent: 'B' }
      ]
    },
    { 
      suite: 'static bound values', 
      fixture: 'bound', 
      model: {
        lang: 'en',
        text: [
          'Parameter {1} and {2} are rendered.',
          'A',
          'B'
        ]
      }, 
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'Parameter ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' and ' },
        { nodeName: 'CONTENT', select: '[param=\'2\']' },
        { nodeName: '#text', data: ' are rendered.' }
      ],
      parameters: [
        { select: 'b[param=\'1\']', textContent: 'A' },
        { select: 'i[param=\'2\']', textContent: 'B' }
      ]
    },
    { 
      suite: 'static compound template', 
      fixture: 'compound-static', 
      model: undefined,
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave her (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and one other person ' },
        { nodeName: 'CONTENT', select: '[param=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'json error', 
      fixture: 'json-error-static', 
      model: undefined,
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1
    },
    { 
      suite: 'no template found', 
      fixture: 'no-template-found-static', 
      model: undefined,
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1
    },
    { 
      suite: 'default number category', 
      fixture: 'default-number-category-static', 
      model: undefined,
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1
    },
    { 
      suite: 'invalid template', 
      fixture: 'invalid-template-static', 
      model: undefined,
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1
    }
/*
    { 
      suite: 'change text values', 
      fixture: 'bound', 
      model: {
        lang: 'en',
        text: [
          'Parameter {1} and {2} are rendered.',
          'A',
          'B'
        ]
      }, 
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      assign: { 
        text: [
          'Param {2} and {1} are rendered.',
          'AAA',
          'BBB'
        ]
      },
      childNodes: [
        { nodeName: '#text', data: 'Param ' },
        { nodeName: 'CONTENT', select: '[param=\'2\']' },
        { nodeName: '#text', data: ' and ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' are rendered.' }
      ],
      parameters: [
        { select: 'b[param=\'1\']', textContent: 'AAA' },
        { select: 'i[param=\'2\']', textContent: 'BBB' }
      ]
    },
    { 
      suite: 'change raw value', 
      fixture: 'bound', 
      model: { number: '987654.321' }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: {},
      assign: { raw: rawValue1 },
      formatted: formatted1_en
    },
    { 
      suite: 'change lang value', 
      fixture: 'bound', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: {},
      assign: { lang: 'fr' },
      formatted: formatted1_fr
    },
    { 
      suite: 'change options object value', 
      fixture: 'bound', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'USD' },
      assign: { options: { 'style': 'currency', 'currency': 'USD' } },
      formatted: formatted1_USD
    },
    { 
      suite: 'change options property values', 
      fixture: 'bound', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'USD' },
      assign: { 'options': {}, 'options.style': 'currency', 'options.currency': 'USD' },
      formatted: formatted1_USD
    },
    { 
      suite: 'change currency options object value', 
      fixture: 'bound-currency-options', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'JPY' },
      assign: { options: { 'style': 'currency', 'currency': 'JPY' } },
      formatted: formatted1_JPY
    },
    { 
      suite: 'change currency options property values', 
      fixture: 'bound-currency-options', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'JPY' },
      assign: { 'options.currency': 'JPY' },
      formatted: formatted1_JPY
    },
    { 
      suite: 'default options object value', 
      fixture: 'bound-default-options', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: undefined,
      formatted: formatted1_en
    },
    { 
      suite: 'change options object value from default options', 
      fixture: 'bound-default-options', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'USD' },
      assign: { options: { 'style': 'currency', 'currency': 'USD' } },
      formatted: formatted1_USD
    },
    { 
      suite: 'change options property values from default options', 
      fixture: 'bound-default-options', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset1,
      rawNumber: rawNumber1,
      number: number1,
      options: { 'style': 'currency', 'currency': 'USD' },
      assign: { 'options': {}, 'options.style': 'currency', 'options.currency': 'USD' },
      formatted: formatted1_USD
    },
    { 
      suite: 'change offset value', 
      fixture: 'bound', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offset2,
      rawNumber: rawNumber1,
      number: number2,
      options: {},
      assign: { offset: offset2 },
      formatted: formatted1_offset
    },
    { 
      suite: 'invalid value', 
      fixture: 'bound', 
      model: { number: rawValueInvalid }, 
      rawValue: rawValueInvalid,
      offset: offset1,
      rawNumber: NaN,
      number: NaN,
      options: {},
      formatted: 'NaN'
    },
    { 
      suite: 'invalid offset value', 
      fixture: 'bound', 
      model: { number: rawValue1 }, 
      rawValue: rawValue1,
      offset: offsetInvalid,
      rawNumber: rawValue1,
      number: NaN,
      options: {},
      assign: { offset: offsetInvalid },
      formatted: 'NaN'
    }
*/
  ];

  var updateProperty = function (element, properties) {
    for (var name in properties) {
      var path = name.split(/[.]/);
      if (path.length === 1) {
        element[name] = properties[name];
      }
      else {
        var cursor = element;
        var p = path.shift();
        while (p) {
          if (path.length < 1) {
            cursor[p] = properties[name];
            element.notifyPath(name, properties[name], true);
            break;
          }
          else if (p === 'PolymerDom') {
            cursor = Polymer.dom(cursor);
          }
          else {
            cursor = cursor[p];
          }
          p = path.shift();
        }
      }
    }
  };

  var updateModel = function (element, model) {
    for (var name in model) {
      var path = name.split(/[.]/);
      if (path.length === 1) {
        if (name === 'lang' && element.is === 'bound-i18n-format') {
          element.locale = model.lang;
        }
        else {
          element[name] = model[name];
        }
        //console.log('updateModel: notifyPath: name = ' + name);
        //element.notifyPath(name, model[name], true);
      }
      else {
        var cursor = element;
        var p = path.shift();
        while (p) {
          if (path.length < 1) {
            cursor[p] = model[name];
            element.notifyPath(name, model[name], true);
            break;
          }
          else if (p === 'PolymerDom') {
            cursor = Polymer.dom(cursor);
          }
          else {
            cursor = cursor[p];
          }
          p = path.shift();
        }
      }
    }
  };

  var getProperty = function (target, name) {
    var path = name.split(/[.]/);
    if (path.length === 1) {
      return target[name];
    }
    else {
      var cursor = target;
      var p = path.shift();
      while (p) {
        if (path.length < 1) {
          return cursor[p];
        }
        else if (p === 'PolymerDom') {
          cursor = Polymer.dom(cursor);
        }
        else {
          cursor = cursor[p];
        }
        p = path.shift();
      }
    }
  };

  suites.forEach(function (params) {

    suite(params.suite, function () {
      var el;
      var rawValue = params.rawValue;
      var fixtureElement;
      var lang = params.assign && params.assign.lang ? params.assign.lang : 'en';

      setup(function () {
        el = params.model
              ? fixture(params.fixture, params.model)
              : fixture(params.fixture, {});
      });

      test('lang property from attribute', function () {
        updateProperty(el, params.assign);
        assert.equal(el.lang, params.lang, 'lang is set');
      });

      test('paramAttribute property is set as ' + params.paramAttribute, function () {
        updateProperty(el, params.assign);
        assert.isString(el.paramAttribute, 'paramAttribute property is a string');
        assert.equal(el.paramAttribute, params.paramAttribute, 'paramAttribute property is set');
      });

      test('paramFormat property is set as ' + params.paramFormat, function () {
        updateProperty(el, params.assign);
        assert.isString(el.paramFormat, 'paramFormat property is a string');
        assert.equal(el.paramFormat, params.paramFormat, 'paramForamt property is set');
      });

      if (params.childNodes) {
        test('childNodes are set as ' + JSON.stringify(params.childNodes), function (done) {
          if (el.lastTemplateText) {
            updateProperty(el, params.assign);
            var childNodes = Polymer.dom(el.root).childNodes;
            var i;
            for (i = 0; i < params.childNodes.length; i++) {
              for (var p in params.childNodes[i]) {
                assert.equal(childNodes[i][p] || childNodes[i].getAttribute(p), params.childNodes[i][p], p + ' is set as ' + params.childNodes[i][p]);
              }
            }
            done();
          }
          else {
            el.addEventListener('rendered', function (e) {
              console.log('handling rendered');
              if (e.target === el) {
                var childNodes = Polymer.dom(el.root).childNodes;
                var i;
                for (i = 0; i < params.childNodes.length; i++) {
                  for (var p in params.childNodes[i]) {
                    assert.equal(childNodes[i][p] || childNodes[i].getAttribute(p), params.childNodes[i][p], p + ' is set as ' + params.childNodes[i][p]);
                  }
                }
                done();
              }
            });
            updateProperty(el, params.assign);
          }
        });
      }

      if (params.parameters) {
        test('parameters are set as ' + JSON.stringify(params.parameters), function (done) {
          if (el.lastTemplateText) {
            updateProperty(el, params.assign);
            var i;
            for (i = 0; i < params.parameters.length; i++) {
              var node = Polymer.dom(el).querySelector(params.parameters[i].select);
              assert.isDefined(node, params.parameters[i].select + ' is defined');
              for (var p in params.parameters[i]) {
                if (p === 'select') {
                  continue;
                }
                assert.equal(getProperty(node, p), params.parameters[i][p], p + ' is set as ' + params.parameters[i][p]);
              }
            }
            done();
          }
          else {
            el.addEventListener('rendered', function (e) {
              console.log('handling rendered');
              if (e.target === el) {
                var i;
                for (i = 0; i < params.parameters.length; i++) {
                  var node = Polymer.dom(el).querySelector(params.parameters[i].select);
                  assert.isDefined(node, params.parameters[i].select + ' is defined');
                  for (var p in params.parameters[i]) {
                    if (p === 'select') {
                      continue;
                    }
                    assert.equal(getProperty(node, p), params.parameters[i][p], p + ' is set as ' + params.parameters[i][p]);
                  }
                }
                done();
              }
            });
            updateProperty(el, params.assign);
          }
        });
      }

    });
  });

  var boundSuites = [
    { 
      suite: 'change bound text values', 
      fixture: 'bound-and-wrapped',
      target: 'simple',
      model: {
        lang: lang1,
        text: [
          'Parameter {1} and {2} are rendered.',
          'A',
          'B'
        ]
      }, 
      assign: { 
        text: [
          'Param {2} and {1} are re-rendered.',
          'AAA',
          'BBB'
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'Param ' },
        { nodeName: 'CONTENT', select: '[param=\'2\']' },
        { nodeName: '#text', data: ' and ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' are re-rendered.' }
      ],
      parameters: [
        { select: 'b[param=\'1\']', textContent: 'AAA' },
        { select: 'i[param=\'2\']', textContent: 'BBB' }
      ]
    },
    { 
      suite: 'plural category other', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: []
      },
      assign: { 
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' },
          { name: 'Yoda', gender: 'other' }
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave them (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' other people gifts.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 2, formatted: '2', 'root.PolymerDom.children.0.textContent': '2' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'plural category one', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: []
      },
      assign: { 
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave her (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and one other person ' },
        { nodeName: 'CONTENT', select: '[param=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'plural category 0', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      assign: { 
        recipients: []
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave no gifts.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: -1, formatted: '-1', rawNumber: 0, 'root.PolymerDom.children.0.textContent': '-1' },
        { select: 'span[param=\'2\']', textContent: '' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: '' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'plural category 1', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      assign: { 
        recipients: [
          { name: 'Alice', gender: 'female' },
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave her (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') ' },
        { nodeName: 'CONTENT', select: '[param=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 0, formatted: '0', rawNumber: 1, 'root.PolymerDom.children.0.textContent': '0' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'gender category default', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: []
      },
      assign: { 
        recipients: [
          { name: 'Yoda', gender: 'unknown' },
          { name: 'Alice', gender: 'female' }
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave them (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and one other person ' },
        { nodeName: 'CONTENT', select: '[param=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[param=\'2\']', textContent: 'unknown' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Yoda' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'update lang and re-render', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        lang: lang1,
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      assign: { 
        lang: lang3 // 'ja' -> plural category 'other'
      },
      lang: lang3,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave them (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and ' },
        { nodeName: 'CONTENT', select: '[param=\'1\']' },
        { nodeName: '#text', data: ' other people gifts.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'unknown lang and re-render', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        lang: lang1,
        recipients: []
      },
      assign: { 
        lang: lang4 // 'xx' -> fallback to 'en'
      },
      lang: lang4,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1
    },
    { 
      suite: 'empty text', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
      },
      assign: { 
        compoundText: []
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 2, formatted: '2', 'root.PolymerDom.children.0.textContent': '2' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: '' }
      ]
    },
    { 
      suite: 'illegal compound template', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
      },
      assign: { 
        compoundText: [
          { 'illegal': 'illegal compound template' }
        ]
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat1,
      childNodes: [],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 2, formatted: '2', 'root.PolymerDom.children.0.textContent': '2' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: '' }
      ]
    },
    { 
      suite: 'change paramFormat', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        compoundText: [
          {
            '0': 'You (%3%) gave no gifts.',
            '1': {
              'male': 'You (%3%) gave him (%4%) %5%.',
              'female': 'You (%3%) gave her (%4%) %5%.',
              'other': 'You (%3%) gave them (%4%) %5%.'
            },
            'one': {
              'male': 'You (%3%) gave him (%4%) and one other person %5%.',
              'female': 'You (%3%) gave her (%4%) and one other person %5%.',
              'other': 'You (%3%) gave them (%4%) and one other person %5%.'
            },
            'other': 'You (%3%) gave them (%4%) and %1% other people gifts.'
          },
          '{{recipients.length}}', // dummy
          '{{recipients.0.gender}}', // dummy
          '{{sender.name}}', // dummy
          '{{recipients.0.name}}', // dummy
          'a gift'
        ],
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      assign: {
        paramFormat: paramFormat2
      },
      lang: lang1,
      paramAttribute: paramAttribute1,
      paramFormat: paramFormat2,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[param=\'3\']' },
        { nodeName: '#text', data: ') gave her (' },
        { nodeName: 'CONTENT', select: '[param=\'4\']' },
        { nodeName: '#text', data: ') and one other person ' },
        { nodeName: 'CONTENT', select: '[param=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[param=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[param=\'2\']', textContent: 'female' },
        { select: 'span[param=\'3\']', textContent: 'Joe' },
        { select: 'span[param=\'4\']', textContent: 'Alice' },
        { select: 'span[param=\'5\']', textContent: 'a gift' }
      ]
    },
    { 
      suite: 'change paramAttribute', 
      fixture: 'bound-and-wrapped',
      target: 'compound',
      model: {
        recipients: [
          { name: 'Alice', gender: 'female' },
          { name: 'Bob', gender: 'male' }
        ]
      },
      assign: {
        paramAttribute: paramAttribute2
      },
      lang: lang1,
      paramAttribute: paramAttribute2,
      paramFormat: paramFormat1,
      childNodes: [
        { nodeName: '#text', data: 'You (' },
        { nodeName: 'CONTENT', select: '[parameter=\'3\']' },
        { nodeName: '#text', data: ') gave her (' },
        { nodeName: 'CONTENT', select: '[parameter=\'4\']' },
        { nodeName: '#text', data: ') and one other person ' },
        { nodeName: 'CONTENT', select: '[parameter=\'5\']' },
        { nodeName: '#text', data: '.' }
      ],
      parameters: [
        { select: 'i18n-number[parameter=\'1\']', number: 1, formatted: '1', 'root.PolymerDom.children.0.textContent': '1' },
        { select: 'span[parameter=\'2\']', textContent: 'female' },
        { select: 'span[parameter=\'3\']', textContent: 'Joe' },
        { select: 'span[parameter=\'4\']', textContent: 'Alice' },
        { select: 'span[parameter=\'5\']', textContent: 'a gift' }
      ]
    }
  ];

  suite('bound in a local DOM', function () {
    var wrapper;
    var el;

    var reattach = function (placeholder) {
      var simple = Polymer.dom(placeholder).querySelector('#simple');
      var compound = Polymer.dom(placeholder).querySelector('#compound');
      Polymer.dom(placeholder).removeChild(simple);
      Polymer.dom(placeholder).appendChild(simple);
      Polymer.dom(placeholder).removeChild(compound);
      Polymer.dom(placeholder).appendChild(compound);
    };

    boundSuites.forEach(function (params) {

      [ false, true ].forEach(function (isReattach) {

        suite(params.suite + (isReattach ? ' with reattaching' : ''), function () {

          setup(function () {
            wrapper = fixture(params.fixture, params.model);
            if (isReattach) {
              reattach(wrapper.$.placeholder);
            }
            el = wrapper.$[params.target];
          });

          test('lang property is ' + params.lang, function (done) {
            var doneCalled = false;
            var langPropertyIsSet;
            if (params.assign &&
                typeof params.assign.lang !== 'undefined' &&
                typeof el.lastTemplateText === 'undefined') {
              console.log('addEventListener rendered');
              el.addEventListener('rendered', langPropertyIsSet = function (e) {
                if (Polymer.dom(e).rootTarget === el &&
                    !doneCalled) {
                  el.removeEventListener('rendered', langPropertyIsSet);
                  assert.equal(el.lang, params.lang, 'lang is ' + params.lang);
                  doneCalled = true;
                  done();
                }
                return false;
              });
              updateModel(el, params.assign);
            }
            else {
              updateModel(el, params.assign);
              assert.equal(el.lang, params.lang, 'lang is ' + params.lang);
              done();
            }
          });

          test('paramAttribute property is ' + params.paramAttribute, function () {
            updateModel(wrapper, params.assign);
            assert.equal(el.paramAttribute, params.paramAttribute, 'paramAttribute is ' + params.paramAttribute);
          });

          test('paramFormat property is ' + params.paramFormat, function () {
            updateModel(wrapper, params.assign);
            assert.equal(el.paramFormat, params.paramFormat, 'paramFormat is ' + params.paramFormat);
          });

          if (params.childNodes) {
            test('updated childNodes are ' + JSON.stringify(params.childNodes), function (done) {
              el.addEventListener('rendered', function (e) {
                if (e.target === el &&
                    params.assign && el.lang === (params.assign.lang ? params.assign.lang : el.DEFAULT_LANG)) {
                  var childNodes = Polymer.dom(el.root).childNodes;
                  var i;
                  for (i = 0; i < params.childNodes.length; i++) {
                    for (var p in params.childNodes[i]) {
                      assert.equal(childNodes[i][p] || childNodes[i].getAttribute(p), params.childNodes[i][p], p + ' is set as ' + params.childNodes[i][p]);
                    }
                  }
                  done();
                }
              });
              updateModel(wrapper, params.assign);
              if (params.childNodes.length === 0 &&
                  Object.getOwnPropertyDescriptor(el, 'lang') &&
                  typeof Object.getOwnPropertyDescriptor(el, 'lang').set !== 'function') {
                el.fire('rendered');
              }
            });
          }

          if (params.parameters) {
            test('updated parameters are ' + JSON.stringify(params.parameters), function (done) {
              el.addEventListener('rendered', function (e) {
                if (e.target === el) {
                  var i;
                  for (i = 0; i < params.parameters.length; i++) {
                    var node = Polymer.dom(el).querySelector(params.parameters[i].select);
                    assert.isDefined(node, params.parameters[i].select + ' is defined');
                    for (var p in params.parameters[i]) {
                      if (p === 'select') {
                        continue;
                      }
                      assert.equal(getProperty(node, p), params.parameters[i][p], p + ' is set as ' + params.parameters[i][p]);
                    }
                  }
                  done();
                }
              });
              updateModel(wrapper, params.assign);
              if (params.childNodes.length === 0 &&
                  Object.getOwnPropertyDescriptor(el, 'lang') &&
                  typeof Object.getOwnPropertyDescriptor(el, 'lang').set !== 'function') {
                window.setTimeout(function () { el.fire('rendered'); }, 10);
              }
            });
          }

    /*
          suite('bound value changed' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.num;
            });

            test('change bound value to ' + rawNumber1, function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '123,456.789', 
                            'renders the formatted number');    
                done();
              });
              wrapper.number = rawNumber1;
            });

          });

          suite('bound value emptied' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.num2;
            });

            test('change bound value to empty', function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '', 
                            'renders the formatted number');    
                done();
              });
              wrapper.number2 = '';
            });

          });

          suite('non-bound empty textContent changed' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.empty;
            });

            test('change empty textContent value to ' + rawNumber1, function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '123,456.789', 
                            'renders the formatted number');    
                done();
              });
              Polymer.dom(el).textContent = rawNumber1;
            });

          });

          suite('currency options value changed' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.currency;
            });

            test('change currency options value to JPY', function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '¥123,457', 
                            'renders the formatted currency');
                done();
              });
              wrapper.options.currency = 'JPY';
              wrapper.notifyPath('options.currency', wrapper.options.currency, true);
            });

          });

          suite('currency options value changed' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.currency;
            });

            test('change currency options value to JPY and render()', function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '¥123,457', 
                            'renders the formatted currency');
                done();
              });
              wrapper.options.currency = 'JPY';
              el.render();
            });

          });

          suite('bound currency options value changed' 
                + (isReattach ? ' with reattaching' : ''), function () {
            setup(function () {
              el = wrapper.$.currency;
            });

            test('change bound currency options value to JPY', function (done) {
              el.addEventListener('rendered', function (e) {
                assert.equal(el.$.number.textContent, '¥123,457', 
                            'renders the formatted currency');
                done();
              });
              wrapper.$.currencySelector.select('JPY');
              //wrapper.notifyPath('options.currency', wrapper.options.currency, true);
            });

          });
    */
        });
      });
    });
  });

});
    </script>

  </body>
</html>
